<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document AI Analyzer</title>
    <!-- CSS embarcado para resolver problema do Vercel -->
    <style>
      /* Bot√µes de exporta√ß√£o pequenos, arredondados e cinza quase branco */
      .export-button {
        background: #f8fafc;
        color: #374151;
        border: none;
        border-radius: 18px;
        padding: 4px 10px;
        font-size: 0.95em;
        margin-left: 6px;
        box-shadow: 0 2px 8px rgba(55, 65, 81, 0.08);
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.2s, box-shadow 0.2s;
      }

      .export-button:hover {
        background: #e5e7eb;
        color: #222;
        box-shadow: 0 4px 16px rgba(55, 65, 81, 0.16);
      }

      /* Bot√£o espec√≠fico para base hist√≥rica */
      #consultarHistorico {
        background: #10b981 !important;
        color: white !important;
      }

      #consultarHistorico:hover {
        background: #059669 !important;
        color: white !important;
      }

      /* Estilos para tabelas comparativas */
      .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      .message-content table th {
        background: #0e938f;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        border: none;
      }

      .message-content table td {
        padding: 10px 8px;
        border: 1px solid #e5e7eb;
        text-align: center;
      }

      .message-content table tr:nth-child(even) {
        background: #f9fafb;
      }

      .message-content table tr:hover {
        background: #f3f4f6;
      }

      /* Destaque para valores na tabela */
      .message-content table .melhor-preco {
        background: #dcfce7 !important;
        color: #166534;
        font-weight: bold;
      }

      .message-content table .pior-preco {
        background: #fecaca !important;
        color: #991b1b;
        font-weight: bold;
      }

      .message-content table .preco-medio {
        background: #fef3c7 !important;
        color: #92400e;
      }
      .analyze-ia-button {
        background: #0e938f !important;
        color: #fff !important;
        border: none !important;
        border-radius: 6px !important;
        padding: 8px 16px !important;
        cursor: pointer !important;
        font-size: 1.2em !important;
        margin: 0 !important;
      }

      .analyze-ia-button:hover {
        background: #0b7a77 !important;
      }

      .send-button {
        background: #0e938f;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 1em;
      }

      .send-button:hover {
        background: #0b7a77;
      }
      .logo-header-tools {
        display: block;
        margin-left: 0;
        margin-bottom: 8px;
        width: 140px;
        height: auto;
        border-radius: 0;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f6f8fa;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 1000px;
        margin: 20px auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        padding: 32px;
      }

      .header h1 {
        font-size: 1.2em;
        margin-bottom: 8px;
      }

      .chat-container {
        min-height: 600px;
        margin-bottom: 16px;
        max-height: 1200px;
        overflow-y: auto;
      }

      .message {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .avatar {
        width: 42px;
        height: 42px;
        background: #10b981;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
        flex-shrink: 0;
        overflow: hidden;
      }

      .message-content {
        background: #f1f5f9;
        padding: 10px 14px;
        border-radius: 6px;
        max-width: 80%;
        line-height: 1.4;
      }

      .input-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .input-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .file-input-label {
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #d1d5db;
        font-size: 1.2em;
      }

      .file-input {
        display: none;
      }

      .message-input {
        flex: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        resize: none;
        font-family: inherit;
      }

      .send-button {
        background: #0e938f;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 1.1em;
      }

      .send-icon {
        font-size: 0.9em;
      }

      .send-button:hover {
        background: #0b7a77;
      }

      .file-preview {
        margin-top: 8px;
        display: none;
      }

      .file-preview.show {
        display: block;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f1f5f9;
        padding: 6px 10px;
        border-radius: 6px;
        margin-bottom: 4px;
      }

      .processing-status {
        font-size: 0.9em;
        color: #6b7280;
        padding: 4px 10px;
        background: #fef3c7;
        border-radius: 4px;
        display: none;
      }

      .remove-file {
        background: none;
        border: none;
        color: #ef4444;
        font-size: 1.2em;
        cursor: pointer;
        padding: 4px;
      }

      .remove-file:hover {
        background: #fee2e2;
        border-radius: 4px;
      }

      .config-toggle {
        position: fixed;
        top: 24px;
        right: 24px;
        background: #10b981;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 1.5em;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .config-toggle:hover {
        background: #059669;
      }

      .config-panel {
        position: fixed;
        top: 70px;
        right: 24px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
        padding: 20px;
        width: 260px;
        display: none;
        z-index: 20;
      }

      .config-panel.open {
        display: block;
      }

      .config-group {
        margin-bottom: 16px;
      }

      .config-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #374151;
      }

      .config-group input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
      }

      .protected-key {
        color: #10b981;
        font-weight: bold;
        font-size: 0.9em;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        flex-shrink: 0;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        color: #ef4444;
        margin: 8px 0;
        font-weight: bold;
        padding: 8px;
        background: #fee2e2;
        border-radius: 4px;
      }

      .logo-tools-avatar {
        display: block;
        width: 100%;
        height: 100%;
        margin: 0;
        background: none;
        border: none;
        border-radius: 50%;
        object-fit: cover;
        aspect-ratio: 1/1;
      }

      .robot-emoji {
        font-size: 2.2em;
        display: block;
        width: 100%;
        height: 100%;
        text-align: center;
        line-height: 42px;
      }

      .file-info span {
        font-size: 0.95em;
        font-weight: normal;
        line-height: 1.4;
        display: inline;
        width: auto;
        height: auto;
        text-align: left;
      }

      #fileName {
        font-size: 0.95em !important;
        font-weight: normal !important;
        line-height: 1.4 !important;
        display: inline !important;
        width: auto !important;
        height: auto !important;
        text-align: left !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <img src="./logo-verde.png" alt="" class="logo-header-tools" />
        <h1>An√°lise de Propostas e Mapa de Concorr√™ncia</h1>
      </div>

      <div class="chat-container" id="chatContainer">
        <!-- Mensagem inicial ser√° adicionada dinamicamente -->
      </div>

      <div class="input-container">
        <div class="input-wrapper">
          <label for="fileInput" class="file-input-label" title="Anexar arquivo"
            >üìé</label
          >
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept=".pdf,.xlsx,.xls"
            multiple
          />
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="Digite sua mensagem..."
            rows="1"
          ></textarea>
          <button id="sendButton" class="send-button">
            <span id="sendIcon" class="send-icon">‚û§</span>
          </button>
          <button id="exportExcel" class="export-button">Exportar Excel</button>
          <button id="exportPDF" class="export-button">Exportar PDF</button>
          <button id="consultarHistorico" class="export-button">
            üìö Base Hist√≥rica
          </button>
        </div>
        <div id="filePreview" class="file-preview">
          <div class="file-info">
            <span id="fileName"></span>
            <button id="removeFile" class="remove-file">‚úï</button>
          </div>
          <div id="processingStatus" class="processing-status"></div>
        </div>
      </div>
    </div>

    <button class="config-toggle" onclick="toggleConfig()">‚öôÔ∏è</button>

    <div id="configPanel" class="config-panel">
      <h3>Configura√ß√µes T√©cnicas</h3>
      <div class="config-group">
        <label for="model">Modelo:</label>
        <select id="model">
          <option value="gpt-4">GPT-4 (Recomendado)</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
      </div>
      <div class="config-group">
        <label for="temperature">Temperatura:</label>
        <input
          type="number"
          id="temperature"
          value="0.7"
          min="0"
          max="1"
          step="0.1"
        />
      </div>
      <div class="config-group">
        <label for="maxTokens">Max Tokens:</label>
        <input type="number" id="maxTokens" value="2000" placeholder="2000" />
      </div>
      <div class="config-group">
        <label for="chunkSize">Tamanho do Chunk (caracteres):</label>
        <input type="number" id="chunkSize" value="3000" placeholder="3000" />
      </div>
      <div class="config-group">
        <span class="protected-key"
          >üîí API Key protegida no servidor - Pronto para uso!</span
        >
      </div>
      <button onclick="saveSettings()" class="save-config-btn">
        Salvar Configura√ß√µes
      </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      // Base hist√≥rica e configura√ß√µes globais
      let baseHistorica = [];
      let currentFiles = [];
      let fileContents = [];
      let processedChunks = new Map();
      let conversationHistory = [];

      // Configura√ß√£o do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

      // Event Listeners
      document.addEventListener("DOMContentLoaded", function () {
        carregarBaseHistorica();
        loadSettings();

        // Event listeners dos elementos
        document
          .getElementById("fileInput")
          .addEventListener("change", handleFileSelect);
        document
          .getElementById("removeFile")
          .addEventListener("click", removeFile);
        document
          .getElementById("sendButton")
          .addEventListener("click", sendMessage);
        document
          .getElementById("messageInput")
          .addEventListener("keydown", handleKeyDown);
        document
          .getElementById("messageInput")
          .addEventListener("input", adjustTextareaHeight);
        document
          .getElementById("exportExcel")
          .addEventListener("click", exportExcel);
        document
          .getElementById("exportPDF")
          .addEventListener("click", exportPDF);
        document
          .getElementById("consultarHistorico")
          .addEventListener("click", consultarBaseHistorica);

        // Exibir mensagem de boas-vindas
        setTimeout(() => {
          const welcomeMessage = `
          <div class="welcome-panel">
            <div class="welcome-header">
              <div class="logo-circle">
                <img src="./logo-verde.png" alt="" />
              </div>
              <span class="welcome-title">SISTEMA AVAN√áADO DE AN√ÅLISE DE BID</span>
            </div>
            <div class="welcome-section">
              <div class="welcome-section-title success">‚úÖ Sistema Carregado:</div>
              <ul>
                <li>Base hist√≥rica: ${baseHistorica.length} an√°lises registradas</li>
                <li>An√°lise comparativa: Ativada</li>
                <li>Exporta√ß√£o Excel/PDF: Dispon√≠vel</li>
                <li>Tabelas visuais: Habilitada</li>
              </ul>
            </div>
            <div class="welcome-section">
              <div class="welcome-section-title info">üöÄ Recursos Dispon√≠veis:</div>
              <ul>
                <li>Upload simult√¢neo de m√∫ltiplos arquivos</li>
                <li>Compara√ß√£o autom√°tica item por item</li>
                <li>Destaque visual de melhores/piores pre√ßos</li>
                <li>Ranking autom√°tico de fornecedores</li>
                <li>Consulta √† base hist√≥rica</li>
                <li>Recomenda√ß√µes estrat√©gicas</li>
              </ul>
            </div>
            <div class="welcome-section">
              <div class="welcome-section-title warning">üìã Para come√ßar:</div>
              <p>Anexe o mapa de concorr√™ncia e as propostas comerciais.</p>
            </div>
            <div class="welcome-section">
              <div class="welcome-section-title example">üí° Exemplo do resultado esperado:</div>
              <table class="welcome-table">
                <tr><th>Item</th><th>Empresa A</th><th>Empresa B</th><th>Melhor</th></tr>
                <tr><td>Ar Condicionado</td><td>R$ 50.000</td><td>R$ 45.000</td><td>Empresa B</td></tr>
                <tr><td>Instala√ß√£o</td><td>R$ 10.000</td><td>R$ 12.000</td><td>Empresa A</td></tr>
              </table>
            </div>
          </div>`;
          addMessage("assistant", welcomeMessage);
        }, 1000);
      });

      // Fun√ß√µes principais
      function loadSettings() {
        const model = localStorage.getItem("openai_model") || "gpt-4";
        const temperature = localStorage.getItem("openai_temperature") || "0.7";
        const maxTokens = localStorage.getItem("max_tokens") || "2000";
        const chunkSize = localStorage.getItem("chunk_size") || "3000";

        document.getElementById("model").value = model;
        document.getElementById("temperature").value = temperature;
        document.getElementById("maxTokens").value = maxTokens;
        document.getElementById("chunkSize").value = chunkSize;
      }

      function saveSettings() {
        const model = document.getElementById("model").value;
        const temperature = document.getElementById("temperature").value;
        const maxTokens = document.getElementById("maxTokens").value;
        const chunkSize = document.getElementById("chunkSize").value;

        localStorage.setItem("openai_model", model);
        localStorage.setItem("openai_temperature", temperature);
        localStorage.setItem("max_tokens", maxTokens);
        localStorage.setItem("chunk_size", chunkSize);

        addMessage(
          "assistant",
          "‚úÖ Configura√ß√µes t√©cnicas salvas com sucesso!"
        );

        const panel = document.getElementById("configPanel");
        panel.classList.remove("open");
      }

      function toggleConfig() {
        const panel = document.getElementById("configPanel");
        panel.classList.toggle("open");
      }

      function adjustTextareaHeight() {
        const textarea = document.getElementById("messageInput");
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      }

      function handleKeyDown(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }

      function addMessage(sender, content) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;
        const messageId = "msg_" + Date.now();
        messageDiv.id = messageId;

        messageDiv.innerHTML = `
          <div class="avatar ${sender}">
            ${
              sender === "user"
                ? "<img src='./tools-avatar-sem-fundo.png' alt='' class='logo-tools-avatar'/>"
                : "<span class='robot-emoji'>ü§ñ</span>"
            }
          </div>
          <div class="message-content">${content}</div>
        `;

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageId;
      }

      function showLoading(messageId) {
        const messageDiv = document.getElementById(messageId);
        const contentDiv = messageDiv.querySelector(".message-content");
        contentDiv.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Analisando...
          </div>
        `;
      }

      function updateMessage(messageId, content) {
        const messageDiv = document.getElementById(messageId);
        const contentDiv = messageDiv.querySelector(".message-content");
        contentDiv.innerHTML = content.replace(/\n/g, "<br>");
      }

      function showError(message) {
        const chatContainer = document.getElementById("chatContainer");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        chatContainer.appendChild(errorDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      // Fun√ß√µes de arquivos
      function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        files.forEach((file) => {
          if (!currentFiles.find((f) => f.name === file.name)) {
            currentFiles.push(file);
          }
        });

        processFiles(files);
        updateFilePreview();
      }

      async function processFiles(files) {
        for (const file of files) {
          try {
            let content = "";

            if (file.name.toLowerCase().endsWith(".pdf")) {
              content = await extractPDFText(file);
            } else if (
              file.name.toLowerCase().endsWith(".xlsx") ||
              file.name.toLowerCase().endsWith(".xls")
            ) {
              content = await extractExcelData(file);
            } else {
              content = await readTextFile(file);
            }

            if (!fileContents.find((f) => f.name === file.name)) {
              fileContents.push({ name: file.name, content: content });
            }
          } catch (error) {
            showError(`Erro ao processar ${file.name}: ${error.message}`);
          }
        }

        if (fileContents.length >= 2) {
          setTimeout(() => {
            structuredAnalysis();
          }, 500);
        }
      }

      async function extractPDFText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            try {
              const typedArray = new Uint8Array(e.target.result);
              const pdf = await pdfjsLib.getDocument(typedArray).promise;
              let fullText = "";

              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items
                  .map((item) => item.str)
                  .join(" ");
                fullText += `\n\n--- P√°gina ${i} ---\n${pageText}`;
              }

              resolve(fullText.trim());
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error("Erro ao ler arquivo PDF"));
          reader.readAsArrayBuffer(file);
        });
      }

      async function extractExcelData(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              let allData = "";

              workbook.SheetNames.forEach((sheetName) => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                });
                allData += `\n\n--- Planilha: ${sheetName} ---\n`;

                jsonData.forEach((row, index) => {
                  if (row.length > 0) {
                    allData += `Linha ${index + 1}: ${row.join(" | ")}\n`;
                  }
                });
              });

              resolve(allData.trim());
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error("Erro ao ler arquivo Excel"));
          reader.readAsArrayBuffer(file);
        });
      }

      async function readTextFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject(new Error("Erro ao ler arquivo"));
          reader.readAsText(file);
        });
      }

      function updateFilePreview() {
        const preview = document.getElementById("filePreview");
        const fileName = document.getElementById("fileName");
        const processingStatus = document.getElementById("processingStatus");

        if (fileContents.length > 0) {
          fileName.textContent = fileContents
            .map((file) => file.name)
            .join(", ");
          processingStatus.textContent = `${fileContents.length} arquivo(s) processado(s)`;
          preview.classList.add("show");
          preview.style.display = "block";
        } else {
          preview.classList.remove("show");
          preview.style.display = "none";
        }
      }

      function removeFile() {
        currentFiles = [];
        fileContents = [];
        processedChunks.clear();

        document.getElementById("fileInput").value = "";
        updateFilePreview();
      }

      // An√°lise estruturada
      async function structuredAnalysis() {
        const loadingId = addMessage("assistant", "");
        showLoading(loadingId);

        try {
          let allContent = "";
          fileContents.forEach((file, index) => {
            allContent += `\n\n=== DOCUMENTO ${
              index + 1
            }: ${file.name.toUpperCase()} ===\n${file.content}`;
          });

          const prompt = `Analise os documentos anexados e crie uma tabela comparativa de pre√ßos.
          
OBRIGAT√ìRIO:
1. Extrair TODOS os pre√ßos em R$
2. Identificar fornecedores/empresas
3. Criar tabela HTML com classe "tabela-comparativa"
4. Destacar menor pre√ßo com classe "melhor-preco"
5. Destacar maior pre√ßo com classe "pior-preco"

Formato da tabela:
<table class="tabela-comparativa">
  <tr class="tabela-cabecalho">
    <th>ITEM/SERVI√áO</th>
    <th>FORNECEDOR A</th>
    <th>FORNECEDOR B</th>
    <th>MELHOR PRE√áO</th>
  </tr>
  <tr>
    <td>Nome do Item</td>
    <td class="melhor-preco">R$ Valor</td>
    <td class="pior-preco">R$ Valor</td>
    <td>Fornecedor Vencedor</td>
  </tr>
</table>`;

          const result = await callBackend(prompt, allContent);
          updateMessage(loadingId, result);

          // Salvar na base hist√≥rica
          await salvarNaBaseHistorica(result);
        } catch (error) {
          updateMessage(loadingId, `‚ùå Erro na an√°lise: ${error.message}`);
        }
      }

      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message && fileContents.length === 0) return;

        if (message) {
          addMessage("user", message);
          input.value = "";
          adjustTextareaHeight();
        }

        const loadingId = addMessage("assistant", "");
        showLoading(loadingId);

        try {
          const prompt =
            "Voc√™ √© um assistente especializado em an√°lise de documentos. Responda em portugu√™s.";
          const response = await callBackend(prompt, message);
          updateMessage(loadingId, response);
        } catch (error) {
          updateMessage(loadingId, `Erro: ${error.message}`);
        }
      }

      async function callBackend(systemPrompt, userMessage) {
        const model = document.getElementById("model").value || "gpt-4";
        const maxTokens =
          parseInt(document.getElementById("maxTokens").value) || 2000;
        const temperature =
          parseFloat(document.getElementById("temperature").value) || 0.7;

        const messages = [
          { role: "system", content: systemPrompt },
          { role: "user", content: userMessage },
        ];

        const response = await fetch(
          "https://analise-bid-ia-backend.onrender.com/api/chat",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: model,
              messages: messages,
              max_tokens: maxTokens,
              temperature: temperature,
            }),
          }
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Erro na API do backend");
        }

        const data = await response.json();
        return data.choices[0].message.content;
      }

      // Fun√ß√µes de exporta√ß√£o
      function exportExcel() {
        const chatContainer = document.getElementById("chatContainer");
        const wb = XLSX.utils.book_new();

        const tables = chatContainer.querySelectorAll("table");
        if (tables.length > 0) {
          tables.forEach((table, index) => {
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, `An√°lise_${index + 1}`);
          });
        } else {
          const chatContent = chatContainer.innerText;
          const ws = XLSX.utils.aoa_to_sheet([
            ["An√°lise de Propostas"],
            ["Data:", new Date().toLocaleDateString()],
            [""],
            [chatContent],
          ]);
          XLSX.utils.book_append_sheet(wb, ws, "An√°lise");
        }

        const filename = `analise_propostas_${new Date()
          .toISOString()
          .slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, filename);
      }

      function exportPDF() {
        const chatContainer = document.getElementById("chatContainer");
        const jsPDF = window.jspdf ? window.jspdf.jsPDF : window.jsPDF;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("TOOLS ENGENHARIA - An√°lise de Propostas", 10, 20);
        doc.setFontSize(10);
        doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 10, 30);

        const chatContent = chatContainer.innerText;
        doc.setFontSize(12);
        const lines = doc.splitTextToSize(chatContent, 180);

        let yPosition = 40;
        lines.forEach((line) => {
          if (yPosition > 280) {
            doc.addPage();
            yPosition = 20;
          }
          doc.text(line, 10, yPosition);
          yPosition += 7;
        });

        const filename = `analise_propostas_${new Date()
          .toISOString()
          .slice(0, 10)}.pdf`;
        doc.save(filename);
      }

      // Base hist√≥rica
      function carregarBaseHistorica() {
        try {
          const historico = localStorage.getItem("baseHistorica");
          baseHistorica = historico ? JSON.parse(historico) : [];
        } catch (error) {
          console.error("Erro ao carregar base hist√≥rica:", error);
          baseHistorica = [];
        }
      }

      async function salvarNaBaseHistorica(analise) {
        try {
          const novaAnalise = {
            data: new Date().toLocaleDateString("pt-BR"),
            hora: new Date().toLocaleTimeString("pt-BR"),
            arquivos: fileContents.map((f) => f.name),
            analise: analise,
            fornecedores: extrairFornecedores(analise),
            itens: contarItens(analise),
            valorTotal: extrairValores(analise),
          };

          baseHistorica.unshift(novaAnalise);

          if (baseHistorica.length > 50) {
            baseHistorica = baseHistorica.slice(0, 50);
          }

          localStorage.setItem("baseHistorica", JSON.stringify(baseHistorica));
        } catch (error) {
          console.error("Erro ao salvar na base hist√≥rica:", error);
        }
      }

      function extrairFornecedores(texto) {
        const empresas = [];
        const regex = /(CNPJ|Empresa|Fornecedor)[:\s]*([A-Z][A-Za-z\s&.-]+)/gi;
        let match;

        while ((match = regex.exec(texto)) !== null) {
          const empresa = match[2].trim();
          if (empresa.length > 3 && !empresas.includes(empresa)) {
            empresas.push(empresa);
          }
        }

        return empresas.slice(0, 10);
      }

      function contarItens(texto) {
        const linhas = texto.split("\n");
        return linhas.filter((linha) => linha.includes("R$")).length;
      }

      function extrairValores(texto) {
        const valores = [];
        const regex = /R\$\s*[\d.,]+/g;
        let match;

        while ((match = regex.exec(texto)) !== null) {
          valores.push(match[0]);
        }

        return valores.slice(0, 20);
      }

      function consultarBaseHistorica() {
        if (baseHistorica.length === 0) {
          addMessage(
            "assistant",
            "üìö Base hist√≥rica vazia. Fa√ßa algumas an√°lises primeiro!"
          );
          return;
        }

        let relatorio = `üìö <strong>BASE HIST√ìRICA - ${baseHistorica.length} AN√ÅLISES</strong><br><br>`;

        baseHistorica.slice(0, 10).forEach((reg, index) => {
          relatorio += `<div class="relatorio-box">
            <strong>üìÑ An√°lise #${baseHistorica.length - index}</strong><br>
            <strong>Data:</strong> ${reg.data} √†s ${reg.hora}<br>
            <strong>Arquivos:</strong> ${reg.arquivos.join(", ")}<br>
            <strong>Fornecedores:</strong> ${
              reg.fornecedores.length
            } empresas<br>
            <strong>Itens:</strong> ${reg.itens} produtos/servi√ßos<br>
          </div>`;
        });

        addMessage("assistant", relatorio);
      }
    </script>
  </body>
</html>
