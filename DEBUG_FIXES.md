# üîß Corre√ß√µes de Debug - Console Errors

## Problemas Identificados e Solu√ß√µes

### 1. ‚ùå `SyntaxError: "[object Object]" is not valid JSON`

**Problema:** Extens√£o do Edge (content.js) tentava fazer `JSON.parse()` em objetos ao inv√©s de strings JSON v√°lidas.

**Causa Raiz:** Linhas 503-505 do `index.html` salvavam dados no localStorage sem convers√£o para string:

```javascript
// ‚ùå ERRADO - Salvava objeto/n√∫mero direto
localStorage.setItem("openai_model", data.modelo); // data.modelo √© string OK
localStorage.setItem("max_tokens", data.max_tokens); // ‚ö†Ô∏è N√∫mero! Causa erro
localStorage.setItem("chunk_size", data.chunk_size); // ‚ö†Ô∏è N√∫mero! Causa erro
```

**Solu√ß√£o:** Converter para string explicitamente:

```javascript
// ‚úÖ CORRETO - Sempre usar String()
localStorage.setItem("openai_model", String(data.modelo || "gpt-5"));
localStorage.setItem("max_tokens", String(data.max_tokens || 4000));
localStorage.setItem("chunk_size", String(data.chunk_size || 8000));
```

---

### 2. ‚ùå `Unchecked runtime.lastError: The message port closed before a response was received`

**Problema:** Comunica√ß√£o entre abas/extens√£o quebrada.

**Causa:** Causado pelos erros de JSON parsing acima, que travavam o runtime.

**Solu√ß√£o:** Fixa-se corrigindo os erros de JSON, al√©m de adicionar valida√ß√£o robusta em `carregarBaseHistorica()`.

---

### 3. ‚ùå `POST https://analise-bid-ia-backend.onrender.com/api/chat 500 (Internal Server Error)`

**Problema:** `"OpenAI retornou resposta vazia mesmo ap√≥s tentativas - tente novamente"`

**Causa Raiz:**

- Backend recebe requisi√ß√£o com mensagens vazias ou inv√°lidas
- OpenAI retorna resposta vazia (poss√≠veis causas: timeout, documentos corrompidos, limite de tokens)
- Backend retorna 500 ao inv√©s de tentar recuperar

**Solu√ß√µes Implementadas:**

#### A. Valida√ß√£o no Frontend (`index.html`)

```javascript
// ‚úÖ Novo: Validar mensagens antes de enviar
if (!systemPrompt || !systemPrompt.trim()) {
  throw new Error("‚ùå Erro: System prompt est√° vazio");
}
if (!userMessage || !userMessage.trim()) {
  throw new Error("‚ùå Erro: Mensagem do usu√°rio est√° vazia");
}
```

#### B. Melhor Tratamento de Erros no Frontend

```javascript
// ‚úÖ Novo: Tratamento robusto de erros da API
if (!content || !content.trim()) {
  throw new Error(
    "Backend retornou conte√∫do vazio. Tente novamente com documentos menores."
  );
}
```

#### C. Retry Inteligente no Backend (`api/index.py`)

```python
# ‚úÖ Novo: M√∫ltiplas tentativas com backoff
retry_count = 0
max_retries = 2
while retry_count < max_retries and (not content or not content.strip()):
    retry_count += 1
    time.sleep(2)  # Aguardar antes de retry
    response2, error2 = process_openai_request(messages, model, max_tokens, retry_attempt=retry_count+1)
    # ... verificar resposta ...
```

#### D. Melhor Logging em `process_openai_request()`

```python
# ‚úÖ Novo: Valida√ß√£o de mensagens antes de enviar
for msg in messages:
    if not msg.get('content') or not msg.get('content').strip():
        log_debug(f"‚ùå ERRO: Mensagem de role '{msg.get('role')}' est√° vazia!")
        raise ValueError(f"Mensagem de role '{msg.get('role')}' est√° vazia")

# ‚úÖ Novo: Preview do conte√∫do
content_preview = msg_content[:50] + "..." if len(msg_content) > 50 else msg_content
log_debug(f"   ‚Ä¢ Mensagem {idx+1} ({msg_role}): {len(msg_content)} chars - {repr(content_preview)}")
```

---

### 4. ‚úÖ `Unchecked runtime.lastError: The message port closed` (Valida√ß√£o localStorage)

**Problema:** `carregarBaseHistorica()` n√£o validava dados do localStorage.

**Solu√ß√£o:** Adicionar try-catch e valida√ß√£o:

```javascript
function carregarBaseHistorica() {
  try {
    const dados = localStorage.getItem("toolsBaseHistorica");
    if (dados) {
      // ‚úÖ Validar se √© string JSON v√°lida antes de fazer parse
      if (typeof dados === "string" && dados.startsWith("[")) {
        baseHistorica = JSON.parse(dados);
      } else if (typeof dados === "object") {
        baseHistorica = dados;
      } else {
        console.warn("‚ö†Ô∏è Dados inv√°lidos no localStorage, limpando...");
        localStorage.removeItem("toolsBaseHistorica");
        baseHistorica = [];
      }
    }
  } catch (error) {
    console.error("‚ùå Erro ao carregar base hist√≥rica:", error);
    localStorage.removeItem("toolsBaseHistorica");
    baseHistorica = [];
  }
}
```

---

## üìã Checklist de Verifica√ß√£o

- [x] localStorage sempre usa `String()` para converter valores
- [x] Valida√ß√£o de mensagens vazias no frontend
- [x] Valida√ß√£o de conte√∫do vazio na resposta
- [x] Retry inteligente no backend (at√© 2 tentativas)
- [x] Backoff de 2 segundos entre retries
- [x] Melhor logging em todas as etapas
- [x] Prote√ß√£o contra JSON parsing de objetos
- [x] Mensagens de erro mais descritivas

---

## üß™ Como Testar

1. **Teste localStorage:**

   ```javascript
   // Abra o DevTools e execute:
   localStorage.getItem("openai_model"); // Deve ser string "gpt-5"
   localStorage.getItem("max_tokens"); // Deve ser string "4000"
   ```

2. **Teste base hist√≥rica:**

   ```javascript
   localStorage.getItem("toolsBaseHistorica"); // Deve ser JSON array
   // Limpar se necess√°rio:
   localStorage.removeItem("toolsBaseHistorica");
   ```

3. **Teste envio de documentos:**

   - Envie um documento PDF/XLSX
   - Verifique no DevTools console os logs de valida√ß√£o
   - Verifique na aba Network a resposta da API

4. **Monitore os logs:**
   - Backend: `app_debug.log` (Render.com)
   - Frontend: DevTools Console (F12)

---

## üöÄ Pr√≥ximos Passos Recomendados

1. **Aumentar timeout do OpenAI** se ainda houver timeouts (linha 103 em `api/index.py`)
2. **Implementar circuit breaker** para evitar sobrecarga
3. **Adicionar m√©tricas** de sucesso/falha de chamadas
4. **Considerar comprimir documentos** antes de enviar se forem muito grandes
5. **Implementar fila de processamento** para requisi√ß√µes em paralelo

---

## üìû Debug R√°pido

Se ainda ver erros 500:

1. Verifique `app_debug.log` no servidor Render
2. Procure por "‚ùå ERRO CR√çTICO: Content vazio"
3. Verifique o tamanho dos documentos (max 30KB de conte√∫do textual)
4. Tente enviar documentos menores separadamente
